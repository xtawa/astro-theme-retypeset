---
import { getCollection } from 'astro:content'
import { allLocales } from '@/config'
import { getLangFromLocale, getLangRouteParam } from '@/i18n/lang'
import { getPostPath, getTagPath } from '@/i18n/path'
import { ui } from '@/i18n/ui'
import Layout from '@/layouts/Layout.astro'
import { countWords, getRandomSentence } from '@/utils/text'

export async function getStaticPaths() {
  return allLocales.map(lang => ({
    params: { lang: getLangRouteParam(lang) },
  }))
}

const currentLang = getLangFromLocale(Astro.currentLocale)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}

// Get all posts
const posts = (await getCollection('posts'))
  .filter(post => !post.data.draft)
  .filter(post => post.data.lang === currentLang || post.data.lang === '')
  .sort((a, b) => b.data.published.getTime() - a.data.published.getTime())

// Statistics
const totalPosts = posts.length
const totalWords = posts.reduce((acc, post) => acc + countWords(post.body || ''), 0)
const randomQuote = getRandomSentence(posts)

// Tag Stats
const tagCounts = posts.reduce((acc, post) => {
  post.data.tags?.forEach(tag => {
    acc[tag] = (acc[tag] || 0) + 1
  })
  return acc
}, {} as Record<string, number>)

const topTags = Object.entries(tagCounts)
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10) // Top 10 tags

// Group posts by year
const postsByYear = posts.reduce((acc, post) => {
  const year = post.data.published.getFullYear()
  if (!acc[year]) {
    acc[year] = []
  }
  acc[year].push(post)
  return acc
}, {} as Record<number, typeof posts>)

const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a)

function formatNumber(num: number) {
  return new Intl.NumberFormat(currentLang).format(num)
}
---

<Layout>
  <!-- Decorative Line -->
  <div class="uno-decorative-line" />
  
  <div class="heti mb-12">
    <h1>{currentUI.stats}</h1>
  </div>

  <div class="max-w-[var(--content-width)] mx-auto px-4 sm:px-0">
    <!-- Typewriter Effect -->
    <typewriter-effect 
        data-text={randomQuote.text || "Reading is a journey."}
        class="block mb-12 p-8 rounded-2xl bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-800 relative overflow-hidden group"
    >
        <div class="absolute top-0 left-0 w-1 h-full bg-primary/20 group-hover:bg-primary/40 transition-colors"></div>
        <div class="font-serif text-xl md:text-2xl leading-relaxed text-gray-800 dark:text-gray-200 min-h-[3rem]">
            <span class="typewriter-content"></span><span class="animate-pulse text-primary">|</span>
        </div>
        <div class="mt-4 text-right text-sm text-gray-500 dark:text-gray-400 opacity-0 transition-opacity duration-1000 typewriter-source">
            —— <a href={getPostPath(randomQuote.link, currentLang)} class="hover:text-primary transition-colors border-b border-dashed border-gray-300 dark:border-gray-600 hover:border-primary">{randomQuote.title}</a>
        </div>
    </typewriter-effect>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-16">
      <div class="p-6 rounded-2xl bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-800">
        <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">{currentUI.posts}</div>
        <div class="text-3xl font-bold text-primary">{formatNumber(totalPosts)}</div>
      </div>
      <div class="p-6 rounded-2xl bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-800">
        <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Words</div>
        <div class="text-3xl font-bold text-primary">{formatNumber(totalWords)}</div>
      </div>
    </div>

    <!-- Top Tags -->
    {topTags.length > 0 && (
      <div class="mb-16">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
          <span class="i-ri-hashtag text-primary"></span>
          Top Tags
        </h2>
        <div class="flex flex-wrap gap-3">
          {topTags.map(([tag, count], index) => (
            <a 
              href={getTagPath(tag, currentLang)}
              class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-800 hover:border-primary/30 hover:bg-primary/5 transition-colors group"
            >
              <span class={`font-medium ${index < 3 ? 'text-primary' : ''}`}>#{tag}</span>
              <span class="text-xs bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded-full text-gray-600 dark:text-gray-300 group-hover:bg-primary/20 group-hover:text-primary transition-colors">{count}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    <!-- Timeline -->
    <div class="relative pl-8 border-l border-gray-200 dark:border-gray-800 space-y-12">
      {years.map(year => (
        <div class="relative">
          <span class="absolute -left-[39px] top-0 flex items-center justify-center w-5 h-5 rounded-full bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-xs font-bold text-gray-500 dark:text-gray-400">
            
          </span>
          <h2 class="text-2xl font-bold mb-6 mt-[-6px] opacity-80">{year}</h2>
          
          <div class="space-y-8">
            {postsByYear[year].map(post => (
              <article class="group relative">
                <div class="absolute -left-[37px] top-2 w-3 h-3 rounded-full bg-primary/20 group-hover:bg-primary transition-colors duration-300"></div>
                <div class="flex flex-col sm:flex-row sm:items-baseline gap-2 sm:gap-4">
                  <time class="font-mono text-sm text-gray-500 dark:text-gray-400 shrink-0 w-24">
                    {post.data.published.toLocaleDateString(currentLang, { month: '2-digit', day: '2-digit' })}
                  </time>
                  <h3 class="text-lg font-medium leading-tight">
                    <a href={getPostPath(post.data.abbrlink || post.id, currentLang)} class="hover:text-primary transition-colors">
                      {post.data.title}
                    </a>
                  </h3>
                </div>
              </article>
            ))}
          </div>
        </div>
      ))}
    </div>
  </div>
</Layout>

<script>
    class TypewriterEffect extends HTMLElement {
        private timeoutId: number | undefined;
        private contentEl: HTMLElement | null = null;
        private sourceEl: HTMLElement | null = null;

        constructor() {
            super();
        }

        connectedCallback() {
            this.contentEl = this.querySelector('.typewriter-content');
            this.sourceEl = this.querySelector('.typewriter-source');
            const text = this.dataset.text || '';

            if (this.contentEl && this.sourceEl) {
                // Clear content immediately to prevent flashing from cached state
                this.contentEl.textContent = '';
                this.sourceEl.classList.add('opacity-0');
                
                // Start typing
                this.type(text, 0);
            }
        }

        disconnectedCallback() {
            if (this.timeoutId) {
                clearTimeout(this.timeoutId);
            }
        }

        type(text: string, index: number) {
            if (!this.isConnected) return;

            if (index < text.length) {
                if (this.contentEl) {
                    this.contentEl.textContent += text.charAt(index);
                }
                const delay = Math.random() * 70 + 30;
                this.timeoutId = window.setTimeout(() => this.type(text, index + 1), delay);
            } else {
                if (this.sourceEl) {
                    this.sourceEl.classList.remove('opacity-0');
                }
            }
        }
    }

    customElements.define('typewriter-effect', TypewriterEffect);
</script>
