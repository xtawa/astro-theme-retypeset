---
import { allLocales, themeConfig } from '@/config'
import { getLangFromLocale, getLangRouteParam } from '@/i18n/lang'
import { ui } from '@/i18n/ui'
import Layout from '@/layouts/Layout.astro'

export async function getStaticPaths() {
  return allLocales.map(lang => ({
    params: { lang: getLangRouteParam(lang) },
  }))
}

const currentLang = getLangFromLocale(Astro.currentLocale)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}

const algoliaConfig = themeConfig.search?.algolia
const isAlgoliaEnabled = algoliaConfig?.enabled && algoliaConfig.appId && algoliaConfig.apiKey && algoliaConfig.indexName
---

<Layout>
  <!-- Decorative Line -->
  <div class="uno-decorative-line" />
  
  <div class="heti mb-12">
    <h1>{currentUI.search}</h1>
  </div>

  <div class="max-w-[var(--content-width)] mx-auto px-4 sm:px-0">
    {isAlgoliaEnabled ? (
      <div id="docsearch" class="ml-3 p-4"></div>
    ) : (
      <div class="ml-3 p-4 text-gray-500">
        <p>Search is not configured. Please configure Algolia DocSearch in <code>src/config.ts</code>.</p>
        <p class="mt-2">See <a href="https://docsearch.algolia.com/apply/" class="text-primary underline" target="_blank">Algolia DocSearch</a> to apply for free.</p>
      </div>
    )}
  </div>

  {isAlgoliaEnabled && (
    <>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3" />
      <script is:inline define:vars={{ appId: algoliaConfig!.appId, apiKey: algoliaConfig!.apiKey, indexName: algoliaConfig!.indexName }}>
        function initDocSearch() {
          const container = document.getElementById('docsearch');
          // Check if container exists
          if (!container) return;
          
          // Check if docsearch is loaded
          if (typeof docsearch === 'undefined') {
            console.warn('DocSearch not loaded yet, retrying in 100ms...');
            setTimeout(initDocSearch, 100);
            return;
          }
          
          // Clear container to prevent duplicates
          container.innerHTML = '';
          
          try {
            docsearch({
              appId: appId,
              apiKey: apiKey,
              indexName: indexName,
              container: '#docsearch',
              debug: true, // Enable debug mode for troubleshooting
              searchParameters: {
                // Try to get more results
                hitsPerPage: 10,
              },
            });
            console.log('DocSearch initialized successfully with:', { appId, indexName });
          } catch (e) {
            console.error('DocSearch init failed:', e);
          }
        }
        
        // Load DocSearch JS if not already loaded
        if (!document.getElementById('docsearch-script')) {
          const script = document.createElement('script');
          script.id = 'docsearch-script';
          script.src = 'https://cdn.jsdelivr.net/npm/@docsearch/js@3';
          script.onload = initDocSearch;
          script.onerror = (e) => console.error('Failed to load DocSearch script:', e);
          document.head.appendChild(script);
        } else {
          // If script exists, initialize immediately
          initDocSearch();
        }
        
        // Note: Since this is an inline script, it runs every time the page content is updated 
        // by View Transitions, so we don't need a separate 'astro:page-load' listener 
        // which would accumulate duplicates.
      </script>
    </>
  )}
  
  <style is:global>
    /* Customize DocSearch UI to match theme */
    :root {
      --docsearch-primary-color: var(--c-main);
      --docsearch-text-color: var(--c-text);
      --docsearch-muted-color: var(--c-text-light);
      --docsearch-container-background: rgba(0, 0, 0, 0.5);
      --docsearch-modal-background: var(--c-bg);
      --docsearch-searchbox-background: var(--c-bg);
      --docsearch-searchbox-focus-background: var(--c-bg);
      --docsearch-hit-background: var(--c-bg);
      --docsearch-footer-background: var(--c-bg);
    }

    .dark {
      --docsearch-primary-color: var(--c-main);
      --docsearch-text-color: var(--c-text);
      --docsearch-muted-color: var(--c-text-light);
      --docsearch-modal-background: var(--c-bg);
      --docsearch-searchbox-background: var(--c-bg);
      --docsearch-searchbox-focus-background: var(--c-bg);
      --docsearch-hit-background: var(--c-bg);
      --docsearch-footer-background: var(--c-bg);
    }

    /* Make search button full width */
    .DocSearch-Button {
      width: 100%;
      margin: 0;
      padding: 12px 16px;
      border-radius: 8px;
      background-color: var(--c-bg);
      border: 1px solid var(--c-border);
    }

    .DocSearch-Button:hover {
      border-color: var(--c-main);
    }

    .DocSearch-Button-Placeholder {
      font-size: 1rem;
    }
  </style>
</Layout>
