---
import { allLocales } from '@/config'
import { getLangFromLocale, getLangRouteParam } from '@/i18n/lang'
import { ui } from '@/i18n/ui'
import Layout from '@/layouts/Layout.astro'

export async function getStaticPaths() {
  return allLocales.map(lang => ({
    params: { lang: getLangRouteParam(lang) },
  }))
}

const currentLang = getLangFromLocale(Astro.currentLocale)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}
---

<Layout>
  <!-- Decorative Line -->
  <div class="uno-decorative-line" />
  
  <div class="heti mb-12">
    <h1>{currentUI.search}</h1>
  </div>

  <div class="max-w-[var(--content-width)] mx-auto px-4 sm:px-0">
    <div id="search" class="ml-3 p-4">
      <p id="search-loading" class="text-gray-500">Loading search...</p>
    </div>
  </div>

  <script is:inline>
    function initPagefind() {
      const searchContainer = document.getElementById('search');
      const loadingMessage = document.getElementById('search-loading');
      if (!searchContainer) return;
      
      // Load Pagefind CSS
      if (!document.querySelector('link[href="/pagefind/pagefind-ui.css"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = '/pagefind/pagefind-ui.css';
        document.head.appendChild(link);
      }
      
      // Load Pagefind JS
      const script = document.createElement('script');
      script.src = '/pagefind/pagefind-ui.js';
      script.onload = function() {
        if (typeof PagefindUI !== 'undefined') {
          // Clear loading message
          searchContainer.innerHTML = '';
          
          new PagefindUI({
            element: '#search',
            showSubResults: true,
            showImages: false,
            translations: {
              placeholder: 'Search...',
              zero_results: 'No results found for "[SEARCH_TERM]"',
            }
          });
        }
      };
      script.onerror = function() {
        if (loadingMessage) {
          loadingMessage.textContent = 'Search is only available after building the site. Run "pnpm build && pnpm preview" to test.';
        }
      };
      document.head.appendChild(script);
    }
    
    // Initialize on first load
    document.addEventListener('DOMContentLoaded', initPagefind);
    
    // Reinitialize on View Transitions navigation
    document.addEventListener('astro:page-load', initPagefind);
  </script>
  
  <style is:global>
    /* Customize Pagefind UI to match theme */
    :root {
      --pagefind-ui-scale: 1;
      --pagefind-ui-primary: var(--c-main);
      --pagefind-ui-text: var(--c-text);
      --pagefind-ui-background: var(--c-bg);
      --pagefind-ui-border: var(--c-border);
      --pagefind-ui-tag: var(--c-main);
      --pagefind-ui-border-width: 1px;
      --pagefind-ui-border-radius: 0.25rem;
      --pagefind-ui-image-border-radius: 0.25rem;
      --pagefind-ui-image-box-ratio: 3 / 2;
      --pagefind-ui-font: inherit;
    }

    .dark {
      --pagefind-ui-primary: var(--c-main);
      --pagefind-ui-text: var(--c-text);
      --pagefind-ui-background: var(--c-bg);
      --pagefind-ui-border: var(--c-border);
      --pagefind-ui-tag: var(--c-main);
    }

    /* Additional tweaks for better integration */
    .pagefind-ui__search-input {
      background-color: transparent;
      color: var(--c-text);
    }
    
    .pagefind-ui__result-title {
      color: var(--c-main) !important;
    }
    
    .pagefind-ui__result-excerpt {
      color: var(--c-text-light) !important;
    }
  </style>
</Layout>
