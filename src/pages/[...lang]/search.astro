---
import { allLocales } from '@/config'
import { getLangFromLocale, getLangRouteParam } from '@/i18n/lang'
import { ui } from '@/i18n/ui'
import Layout from '@/layouts/Layout.astro'

export async function getStaticPaths() {
  return allLocales.map(lang => ({
    params: { lang: getLangRouteParam(lang) },
  }))
}

const currentLang = getLangFromLocale(Astro.currentLocale)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}
---

<Layout>
  <!-- Decorative Line -->
  <div class="uno-decorative-line" />
  
  <div class="heti mb-12">
    <h1>{currentUI.search}</h1>
  </div>

  <div class="max-w-[var(--content-width)] mx-auto px-4 sm:px-0">
    <div class="mb-8">
      <input
        type="text"
        id="lunr-search-input"
        placeholder="Type to search..."
        class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:border-primary"
      />
    </div>

    <div id="lunr-search-results">
      <p id="lunr-no-results" class="hidden text-gray-500">No results found.</p>
    </div>
  </div>

  <script is:inline>
    // Load lunr.js dynamically as it's a client-side dependency
    const loadScript = (src) => {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    };

    window.addEventListener('DOMContentLoaded', async () => {
      // Dynamically load lunr.js
      await loadScript('https://unpkg.com/lunr/lunr.min.js'); // Using unpkg for simplicity, can be bundled
      
      const searchInput = document.getElementById('lunr-search-input');
      const searchResults = document.getElementById('lunr-search-results');
      const noResultsMessage = document.getElementById('lunr-no-results');

      let idx;
      let documents;

      // Fetch the search index and documents
      try {
        const [indexResponse, docsResponse] = await Promise.all([
          fetch('/search-index.json'),
          fetch('/search-documents.json')
        ]);
        
        if (!indexResponse.ok || !docsResponse.ok) {
          throw new Error('Failed to load search index or documents.');
        }

        const indexData = await indexResponse.json();
        documents = await docsResponse.json();

        // Rehydrate Lunr.js index
        idx = lunr.Index.load(indexData);
      } catch (error) {
        console.error('Error loading Lunr.js index:', error);
        searchInput.placeholder = 'Search not available.';
        searchInput.disabled = true;
        return;
      }

      searchInput.addEventListener('input', (event) => {
        const query = event.target.value;
        searchResults.innerHTML = ''; // Clear previous results
        noResultsMessage.classList.add('hidden');

        if (query.length < 2) { // Require at least 2 characters for search
          return;
        }

        const results = idx.search(query);

        if (results.length === 0) {
          noResultsMessage.classList.remove('hidden');
          return;
        }

        results.forEach(result => {
          const doc = documents.find(d => d.id === result.ref);
          if (doc) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'p-4 mb-4 border border-gray-200 rounded';
            resultDiv.innerHTML = `
              <h3 class="text-xl font-bold mb-2">
                <a href="${doc.url}" class="text-primary hover:underline">${doc.title}</a>
              </h3>
              <p class="text-gray-700 text-sm">${doc.content.substring(0, 200)}...</p>
            `;
            searchResults.appendChild(resultDiv);
          }
        });
      });
    });
  </script>
</Layout>
